<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Substation Interlock Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Dark mode styles */
        body.dark {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .dark .bg-white { background-color: #2a2a2a; }
        .dark .bg-gray-100 { background-color: #1a1a1a; }
        .dark .text-gray-900 { color: #e0e0e0; }
        .dark .text-gray-800 { color: #d0d0d0; }
        .dark .text-gray-700 { color: #b0b0b0; }
        .dark .text-gray-600 { color: #a0a0a0; }
        .dark .border-gray-300 { border-color: #4a4a4a; }
        .dark .label { fill: #d0d0d0; }
        
        /* Switch animations */
        .switch {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        .switch:hover {
            transform: scale(1.1);
        }
        .switch.animating {
            animation: switchPulse 0.5s ease-out;
        }
        @keyframes switchPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Switch states */
        .switch.closed .switch-line { fill: #10B981; stroke: #10B981; }
        .switch.open .switch-line { fill: #EF4444; stroke: #EF4444; }
        .switch.earthed .switch-line { fill: #F59E0B; stroke: #F59E0B; }
        .switch-rect { 
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .switch.closed .switch-rect { stroke: #10B981; fill: #10B98120; }
        .switch.open .switch-rect { stroke: #EF4444; fill: #EF444420; }
        .switch.earthed .switch-rect { stroke: #F59E0B; fill: #F59E0B20; }
        
        /* Power flow animation */
        @keyframes powerFlow {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }
        .power-flow {
            stroke: #10B981;
            stroke-width: 2;
            stroke-dasharray: 5, 15;
            animation: powerFlow 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .power-flow.active {
            opacity: 0.7;
        }
        
        /* Busbar styles */
        .busbar {
            stroke: #4B5563;
            stroke-width: 8;
            fill: #4B5563;
            transition: all 0.3s;
        }
        .busbar.energized {
            stroke: #10B981;
            fill: #10B981;
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.5));
        }
        
        /* Line styles */
        .line {
            stroke: #6B7280;
            stroke-width: 3;
            fill: none;
            transition: all 0.3s;
        }
        .line.energized {
            stroke: #10B981;
            filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.3));
        }
        
        /* Label styles */
        .label {
            font-size: 14px;
            font-weight: 500;
            fill: #374151;
            text-anchor: middle;
            pointer-events: none;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 250px;
        }
        .tooltip.show {
            opacity: 1;
        }
        
        /* Status dot */
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Tutorial highlight */
        .tutorial-highlight {
            animation: highlightPulse 1.5s infinite;
        }
        @keyframes highlightPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8));
                transform: scale(1.05);
            }
            50% { 
                filter: drop-shadow(0 0 20px rgba(59, 130, 246, 1));
                transform: scale(1.1);
            }
        }
        
        /* Transformer symbol */
        .transformer {
            stroke: #6B7280;
            stroke-width: 2;
            fill: none;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #10B981);
            transition: width 0.5s ease;
        }
        
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-300">
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Advanced Substation Simulator</h1>
            <p class="mt-2 text-lg text-gray-600">Master Interlocking Systems with Interactive Training</p>
            <div class="mt-4 flex justify-center gap-4">
                <button id="darkModeToggle" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition">
                    <span id="darkModeIcon">ðŸŒ™</span> <span id="darkModeText">Dark Mode</span>
                </button>
                <button id="soundToggle" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <span id="soundIcon">ðŸ”Š</span> Sound: <span id="soundStatus">ON</span>
                </button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Controls Panel -->
            <div class="lg:w-1/3 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Control Center</h2>
                
                <!-- Mode Tabs -->
                <div class="flex gap-2 mb-6">
                    <button id="practiceTab" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">Practice</button>
                    <button id="tutorialTab" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Tutorial</button>
                    <button id="quizTab" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Quiz</button>
                </div>
                
                <!-- Practice Mode Controls -->
                <div id="practiceControls" class="space-y-6">
                    <div>
                        <label for="operationSelect" class="block text-sm font-medium text-gray-700 mb-2">Operation Scenario:</label>
                        <select id="operationSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="none" selected>-- Select Operation --</option>
                            <optgroup label="Feeder Bay (220/66KV)">
                                <option value="feeder_service">Feeder Bay - Service</option>
                                <option value="feeder_maintenance">Feeder Bay - Maintenance</option>
                            </optgroup>
                            <optgroup label="Bus Coupler (220/66KV)">
                                <option value="bus_coupler_service">Bus Coupler - Service</option>
                                <option value="bus_coupler_maintenance">Bus Coupler - Maintenance</option>
                            </optgroup>
                            <optgroup label="Advanced Operations">
                                <option value="bus_transfer">Bus Transfer Operation</option>
                                <option value="emergency_isolation">Emergency Isolation</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="applyScenario" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Show Solution</button>
                        <button id="checkConfig" class="bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105">Check Config</button>
                        <button id="undoBtn" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition">â†¶ Undo</button>
                        <button id="redoBtn" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition">â†· Redo</button>
                    </div>
                    
                    <button id="reset" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition">Reset All</button>
                </div>
                
                <!-- Tutorial Mode Controls -->
                <div id="tutorialControls" class="space-y-6 hidden">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold mb-2">Tutorial Mode</h3>
                        <p class="text-sm text-gray-600 mb-4">Follow the step-by-step guide to learn proper switching sequences.</p>
                        <div class="progress-bar mb-2">
                            <div id="tutorialProgress" class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <p class="text-sm">Step <span id="currentStep">0</span> of <span id="totalSteps">0</span></p>
                    </div>
                    <button id="startTutorial" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Start Tutorial</button>
                    <button id="nextStep" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition hidden">Next Step â†’</button>
                    <div id="tutorialInstructions" class="p-4 bg-yellow-50 rounded-lg hidden">
                        <p class="text-sm"></p>
                    </div>
                </div>
                
                <!-- Quiz Mode Controls -->
                <div id="quizControls" class="space-y-6 hidden">
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <h3 class="font-semibold mb-2">Quiz Mode</h3>
                        <p class="text-sm text-gray-600 mb-4">Test your knowledge with random scenarios!</p>
                        <div class="text-2xl font-bold text-purple-600">Score: <span id="quizScore">0</span></div>
                        <div class="text-sm text-gray-600">Streak: <span id="quizStreak">0</span></div>
                    </div>
                    <button id="startQuiz" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition">Start New Quiz</button>
                    <div id="quizChallenge" class="p-4 bg-gray-50 rounded-lg hidden">
                        <p class="font-semibold mb-2">Challenge:</p>
                        <p class="text-sm"></p>
                    </div>
                    <button id="submitQuiz" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition hidden">Submit Answer</button>
                </div>

                <!-- Status Display -->
                <div id="status" class="mt-6 p-4 rounded-lg transition-all duration-300"></div>
                
                <!-- Statistics -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-semibold mb-2">Session Statistics</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>Operations: <span id="operationCount" class="font-bold">0</span></div>
                        <div>Success Rate: <span id="successRate" class="font-bold">0%</span></div>
                        <div>Total Clicks: <span id="clickCount" class="font-bold">0</span></div>
                        <div>Time: <span id="sessionTime" class="font-bold">0:00</span></div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-lg font-semibold mb-3">Legend</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center"><span class="status-dot bg-green-500"></span> Closed / On</li>
                        <li class="flex items-center"><span class="status-dot bg-red-500"></span> Open / Off</li>
                        <li class="flex items-center"><span class="status-dot bg-amber-500"></span> Earthed</li>
                        <li class="flex items-center"><span class="status-dot bg-blue-500"></span> Tutorial Focus</li>
                    </ul>
                </div>
            </div>

            <!-- Diagram Panel -->
            <div class="lg:w-2/3 bg-white p-4 rounded-2xl shadow-lg">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Single Line Diagram</h3>
                    <div class="flex gap-2">
                        <button id="togglePowerFlow" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition">Show Power Flow</button>
                        <button id="toggleLabels" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition">Toggle Labels</button>
                    </div>
                </div>
                <svg id="substationDiagram" viewBox="0 0 900 650" class="w-full h-full">
                    <!-- Transformer symbols -->
                    <g id="transformer1" transform="translate(250, 320)">
                        <circle cx="0" cy="0" r="20" class="transformer" />
                        <circle cx="0" cy="0" r="15" class="transformer" />
                        <text x="30" y="5" class="label" font-size="12">T1</text>
                    </g>
                    
                    <g id="transformer2" transform="translate(550, 320)">
                        <circle cx="0" cy="0" r="20" class="transformer" />
                        <circle cx="0" cy="0" r="15" class="transformer" />
                        <text x="30" y="5" class="label" font-size="12">T2</text>
                    </g>

                    <!-- Power flow indicators (initially hidden) -->
                    <path id="powerFlow1" d="M200 150 L200 450" class="power-flow" />
                    <path id="powerFlow2" d="M350 100 L350 150" class="power-flow" />
                    <path id="powerFlow3" d="M450 100 L450 150" class="power-flow" />
                    <path id="powerFlow4" d="M350 450 L350 500" class="power-flow" />
                    <path id="powerFlow5" d="M450 450 L450 500" class="power-flow" />

                    <!-- Busbars -->
                    <rect x="150" y="100" width="500" height="10" class="busbar" id="BB1A" data-tooltip="Busbar 1A - Primary 220kV busbar section A" />
                    <text x="100" y="108" class="label">BB 1A</text>
                    
                    <rect x="150" y="150" width="500" height="10" class="busbar" id="BB1B" data-tooltip="Busbar 1B - Primary 220kV busbar section B" />
                    <text x="100" y="158" class="label">BB 1B</text>
                    
                    <rect x="150" y="450" width="500" height="10" class="busbar" id="BB2A" data-tooltip="Busbar 2A - Secondary 66kV busbar section A" />
                    <text x="100" y="458" class="label">BB 2A</text>
                    
                    <rect x="150" y="500" width="500" height="10" class="busbar" id="BB2B" data-tooltip="Busbar 2B - Secondary 66kV busbar section B" />
                    <text x="100" y="508" class="label">BB 2B</text>

                    <!-- Feeder Lines & Switches -->
                    <line x1="200" y1="150" x2="200" y2="450" class="line" id="feederLine" />
                    
                    <g class="switch" id="Q1" data-state="open" data-tooltip="Q1 - Isolator for Busbar 1A connection">
                        <rect x="185" y="180" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M190 195 L210 195" class="switch-line" stroke-width="4"/>
                        <text x="200" y="225" class="label">Q1</text>
                    </g>
                    
                    <g class="switch" id="Q2" data-state="open" data-tooltip="Q2 - Isolator for Busbar 1B connection">
                        <rect x="185" y="240" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M190 255 L210 255" class="switch-line" stroke-width="4"/>
                        <text x="200" y="285" class="label">Q2</text>
                    </g>
                    
                    <g class="switch" id="Q0" data-state="open" data-tooltip="Q0 - Main Circuit Breaker">
                        <rect x="185" y="300" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M190 315 L210 315" class="switch-line" stroke-width="4"/>
                        <text x="200" y="345" class="label">Q0</text>
                    </g>
                    
                    <g class="switch" id="Q9" data-state="open" data-tooltip="Q9 - Line Isolator">
                        <rect x="185" y="360" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M190 375 L210 375" class="switch-line" stroke-width="4"/>
                        <text x="200" y="405" class="label">Q9</text>
                    </g>
                    
                    <line x1="200" y1="410" x2="200" y2="550" class="line" />
                    <text x="200" y="570" class="label">220KV Feeder</text>

                    <!-- Outgoing Bay -->
                    <line x1="600" y1="100" x2="600" y2="50" class="line"/>
                    <line x1="600" y1="50" x2="650" y1="50" class="line"/>
                    <path d="M650 50 L630 40 M650 50 L630 60" class="line" />
                    <text x="600" y="30" class="label">Outgoing 66KV</text>
                    
                    <g class="switch" id="Q8" data-state="open" data-tooltip="Q8 - Outgoing Circuit Breaker">
                        <rect x="585" y="65" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M590 80 L610 80" class="switch-line" stroke-width="4"/>
                        <text x="560" y="85" class="label">Q8</text>
                    </g>

                    <!-- Bus Coupler Switches -->
                    <line x1="350" y1="100" x2="350" y2="150" class="line"/>
                    <g class="switch" id="Q11" data-state="open" data-tooltip="Q11 - Bus Coupler Isolator BB1A">
                        <rect x="335" y="115" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M340 130 L360 130" class="switch-line" stroke-width="4" transform="rotate(90 350 125)"/>
                        <text x="380" y="130" class="label">Q11</text>
                    </g>

                    <line x1="450" y1="100" x2="450" y2="150" class="line"/>
                    <g class="switch" id="Q12" data-state="open" data-tooltip="Q12 - Bus Coupler Isolator BB1B">
                        <rect x="435" y="115" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M440 130 L460 130" class="switch-line" stroke-width="4" transform="rotate(90 450 125)"/>
                        <text x="480" y="130" class="label">Q12</text>
                    </g>

                    <line x1="350" y1="450" x2="350" y2="500" class="line"/>
                    <g class="switch" id="Q21" data-state="open" data-tooltip="Q21 - Bus Coupler Isolator BB2A">
                        <rect x="335" y="465" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M340 480 L360 480" class="switch-line" stroke-width="4" transform="rotate(90 350 475)"/>
                        <text x="380" y="480" class="label">Q21</text>
                    </g>

                    <line x1="450" y1="450" x2="450" y2="500" class="line"/>
                    <g class="switch" id="Q22" data-state="open" data-tooltip="Q22 - Bus Coupler Isolator BB2B">
                        <rect x="435" y="465" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M440 480 L460 480" class="switch-line" stroke-width="4" transform="rotate(90 450 475)"/>
                        <text x="480" y="480" class="label">Q22</text>
                    </g>

                    <!-- Earthing Switches -->
                    <g class="switch" id="BB1_earthed" data-state="open" data-tooltip="BB1 Earth - Earthing switch for BB1 maintenance">
                        <rect x="680" y="120" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M685 135 L705 135" class="switch-line" stroke-width="4"/>
                        <text x="700" y="165" class="label">BB1 Earth</text>
                    </g>
                    
                    <g class="switch" id="BB2_earthed" data-state="open" data-tooltip="BB2 Earth - Earthing switch for BB2 maintenance">
                        <rect x="680" y="470" width="30" height="30" rx="4" class="switch-rect" fill="white" stroke-width="2"/>
                        <path d="M685 485 L705 485" class="switch-line" stroke-width="4"/>
                        <text x="700" y="515" class="label">BB2 Earth</text>
                    </g>

                    <!-- Earth symbols -->
                    <g transform="translate(720, 135)">
                        <line x1="0" y1="0" x2="15" y2="0" stroke="#6B7280" stroke-width="2"/>
                        <line x1="15" y1="-5" x2="15" y2="5" stroke="#6B7280" stroke-width="2"/>
                        <line x1="18" y1="-3" x2="18" y2="3" stroke="#6B7280" stroke-width="2"/>
                        <line x1="21" y1="-1" x2="21" y2="1" stroke="#6B7280" stroke-width="2"/>
                    </g>
                    
                    <g transform="translate(720, 485)">
                        <line x1="0" y1="0" x2="15" y2="0" stroke="#6B7280" stroke-width="2"/>
                        <line x1="15" y1="-5" x2="15" y2="5" stroke="#6B7280" stroke-width="2"/>
                        <line x1="18" y1="-3" x2="18" y2="3" stroke="#6B7280" stroke-width="2"/>
                        <line x1="21" y1="-1" x2="21" y2="1" stroke="#6B7280" stroke-width="2"/>
                    </g>
                </svg>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Quick Help</h2>
            <div class="grid md:grid-cols-3 gap-4 text-sm">
                <div>
                    <h3 class="font-semibold mb-2">ðŸŽ¯ Interlocking Principles</h3>
                    <p class="text-gray-600">Interlocks prevent unsafe operations. Never close breakers without proper isolation.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">âš¡ Safety Rules</h3>
                    <p class="text-gray-600">Always isolate before maintenance. Earth all dead sections. Follow proper switching sequences.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">ðŸ”§ Operation Tips</h3>
                    <p class="text-gray-600">Click switches to change state. Hover for tooltips. Use tutorial mode to learn sequences.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Enhanced interlocking data with new scenarios
            const interlockData = {
                feeder_service: {
                    Q1: 'open', Q2: 'open', Q0: 'closed', Q9: 'open', Q8: 'closed',
                    Q11: 'open', Q12: 'open', Q21: 'open', Q22: 'open',
                    BB1_earthed: 'open', BB2_earthed: 'open',
                    description: 'Normal service configuration with feeder in operation'
                },
                feeder_maintenance: {
                    Q1: 'closed', Q2: 'closed', Q0: 'closed', Q9: 'closed', Q8: 'open',
                    Q11: 'open', Q12: 'open', Q21: 'open', Q22: 'open',
                    BB1_earthed: 'earthed', BB2_earthed: 'earthed',
                    description: 'Safe maintenance configuration with proper earthing'
                },
                bus_coupler_service: {
                    Q1: 'open', Q2: 'open', Q0: 'closed', Q9: 'open', Q8: 'open',
                    Q11: 'closed', Q12: 'closed', Q21: 'closed', Q22: 'closed',
                    BB1_earthed: 'open', BB2_earthed: 'open',
                    description: 'Bus coupler in service for parallel operation'
                },
                bus_coupler_maintenance: {
                    Q1: 'closed', Q2: 'closed', Q0: 'closed', Q9: 'open', Q8: 'open',
                    Q11: 'earthed', Q12: 'earthed', Q21: 'earthed', Q22: 'earthed',
                    BB1_earthed: 'open', BB2_earthed: 'open',
                    description: 'Bus coupler isolated and earthed for maintenance'
                },
                bus_transfer: {
                    Q1: 'closed', Q2: 'open', Q0: 'closed', Q9: 'open', Q8: 'closed',
                    Q11: 'closed', Q12: 'open', Q21: 'closed', Q22: 'open',
                    BB1_earthed: 'open', BB2_earthed: 'open',
                    description: 'Transferring load from BB1B to BB1A'
                },
                emergency_isolation: {
                    Q1: 'open', Q2: 'open', Q0: 'open', Q9: 'closed', Q8: 'open',
                    Q11: 'open', Q12: 'open', Q21: 'open', Q22: 'open',
                    BB1_earthed: 'earthed', BB2_earthed: 'earthed',
                    description: 'Emergency isolation with all sections de-energized'
                }
            };

            // Tutorial sequences
            const tutorialSequences = {
                basic_switching: [
                    { switch: 'Q9', action: 'close', instruction: 'First, close the line isolator Q9 to prepare the circuit' },
                    { switch: 'Q1', action: 'close', instruction: 'Close isolator Q1 to connect to Busbar 1A' },
                    { switch: 'Q0', action: 'close', instruction: 'Now close the main circuit breaker Q0 to energize' },
                    { switch: 'Q8', action: 'close', instruction: 'Finally, close Q8 to complete the circuit' },
                ],
                maintenance_prep: [
                    { switch: 'Q0', action: 'open', instruction: 'Open the circuit breaker Q0 first for safety' },
                    { switch: 'Q1', action: 'open', instruction: 'Open isolator Q1 to disconnect from BB1A' },
                    { switch: 'Q2', action: 'open', instruction: 'Open isolator Q2 to disconnect from BB1B' },
                    { switch: 'Q9', action: 'open', instruction: 'Open line isolator Q9 for complete isolation' },
                    { switch: 'BB1_earthed', action: 'earthed', instruction: 'Apply earthing to BB1 for safe maintenance' },
                ]
            };

            // State management
            let currentMode = 'practice';
            let soundEnabled = true;
            let darkMode = false;
            let powerFlowVisible = false;
            let history = [];
            let historyIndex = -1;
            let tutorialStep = 0;
            let currentTutorial = null;
            let stats = {
                operations: 0,
                successful: 0,
                clicks: 0,
                startTime: Date.now(),
                quizScore: 0,
                quizStreak: 0
            };

            // DOM elements
            const switches = document.querySelectorAll('.switch');
            const statusDiv = document.getElementById('status');
            const operationSelect = document.getElementById('operationSelect');
            const tooltip = document.getElementById('tooltip');
            const body = document.body;
            
            // Audio context for sound effects
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const playSound = (frequency, duration) => {
                if (!soundEnabled) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            };

            // Switch state management
            const setSwitchState = (switchEl, state, addToHistory = true) => {
                const oldState = switchEl.dataset.state;
                if (oldState === state) return;
                
                if (addToHistory) {
                    addHistory({ switchId: switchEl.id, oldState, newState: state });
                }
                
                switchEl.dataset.state = state;
                switchEl.classList.remove('open', 'closed', 'earthed', 'animating');
                switchEl.classList.add(state, 'animating');
                
                // Play different sounds for different states
                if (state === 'closed') playSound(440, 0.1);
                else if (state === 'open') playSound(330, 0.1);
                else if (state === 'earthed') playSound(220, 0.2);
                
                setTimeout(() => switchEl.classList.remove('animating'), 500);
                updatePowerFlow();
                stats.clicks++;
                updateStats();
            };

            const toggleSwitchState = (switchEl) => {
                const currentState = switchEl.dataset.state;
                let nextState;
                if (currentState === 'open') nextState = 'closed';
                else if (currentState === 'closed') nextState = 'earthed';
                else nextState = 'open';
                setSwitchState(switchEl, nextState);
            };

            // History management
            const addHistory = (action) => {
                history = history.slice(0, historyIndex + 1);
                history.push(action);
                historyIndex++;
                updateHistoryButtons();
            };

            const undo = () => {
                if (historyIndex < 0) return;
                const action = history[historyIndex];
                const switchEl = document.getElementById(action.switchId);
                setSwitchState(switchEl, action.oldState, false);
                historyIndex--;
                updateHistoryButtons();
            };

            const redo = () => {
                if (historyIndex >= history.length - 1) return;
                historyIndex++;
                const action = history[historyIndex];
                const switchEl = document.getElementById(action.switchId);
                setSwitchState(switchEl, action.newState, false);
                updateHistoryButtons();
            };

            const updateHistoryButtons = () => {
                document.getElementById('undoBtn').disabled = historyIndex < 0;
                document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
            };

            // Power flow visualization
            const updatePowerFlow = () => {
                if (!powerFlowVisible) return;
                
                const flows = document.querySelectorAll('.power-flow');
                const busbars = document.querySelectorAll('.busbar');
                const lines = document.querySelectorAll('.line');
                
                // Simple logic to show power flow based on switch states
                const q0Closed = document.getElementById('Q0').dataset.state === 'closed';
                const q1Closed = document.getElementById('Q1').dataset.state === 'closed';
                const q8Closed = document.getElementById('Q8').dataset.state === 'closed';
                
                flows.forEach(flow => {
                    flow.classList.toggle('active', q0Closed && (q1Closed || q8Closed));
                });
                
                busbars.forEach(busbar => {
                    busbar.classList.toggle('energized', q0Closed && q1Closed);
                });
                
                lines.forEach(line => {
                    line.classList.toggle('energized', q0Closed);
                });
            };

            // Tutorial mode
            const startTutorial = (sequence) => {
                currentTutorial = tutorialSequences[sequence] || tutorialSequences.basic_switching;
                tutorialStep = 0;
                resetAllSwitches();
                showTutorialStep();
                document.getElementById('startTutorial').classList.add('hidden');
                document.getElementById('nextStep').classList.remove('hidden');
                document.getElementById('tutorialInstructions').classList.remove('hidden');
            };

            const showTutorialStep = () => {
                if (tutorialStep >= currentTutorial.length) {
                    showStatus('Tutorial completed! Well done!', 'success');
                    document.getElementById('nextStep').classList.add('hidden');
                    document.getElementById('startTutorial').classList.remove('hidden');
                    clearTutorialHighlights();
                    return;
                }
                
                clearTutorialHighlights();
                const step = currentTutorial[tutorialStep];
                const switchEl = document.getElementById(step.switch);
                switchEl.classList.add('tutorial-highlight');
                
                document.getElementById('tutorialInstructions').querySelector('p').textContent = step.instruction;
                document.getElementById('currentStep').textContent = tutorialStep + 1;
                document.getElementById('totalSteps').textContent = currentTutorial.length;
                document.getElementById('tutorialProgress').style.width = `${((tutorialStep + 1) / currentTutorial.length) * 100}%`;
            };

            const nextTutorialStep = () => {
                const step = currentTutorial[tutorialStep];
                const switchEl = document.getElementById(step.switch);
                setSwitchState(switchEl, step.action);
                tutorialStep++;
                showTutorialStep();
            };

            const clearTutorialHighlights = () => {
                switches.forEach(sw => sw.classList.remove('tutorial-highlight'));
            };

            // Quiz mode
            const startQuiz = () => {
                resetAllSwitches();
                const scenarios = Object.keys(interlockData);
                const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                const config = interlockData[randomScenario];
                
                document.getElementById('quizChallenge').classList.remove('hidden');
                document.getElementById('quizChallenge').querySelector('p:last-child').textContent = 
                    `Configure the switches for: ${config.description}`;
                document.getElementById('submitQuiz').classList.remove('hidden');
                document.getElementById('startQuiz').textContent = 'New Challenge';
                
                // Store the target configuration for checking
                document.getElementById('quizChallenge').dataset.scenario = randomScenario;
            };

            const checkQuizAnswer = () => {
                const scenario = document.getElementById('quizChallenge').dataset.scenario;
                const requiredStates = interlockData[scenario];
                let correct = true;
                
                switches.forEach(sw => {
                    const switchId = sw.id;
                    if (requiredStates[switchId] && sw.dataset.state !== requiredStates[switchId]) {
                        correct = false;
                    }
                });
                
                if (correct) {
                    stats.quizScore += 10;
                    stats.quizStreak++;
                    showStatus(`Correct! +10 points. Streak: ${stats.quizStreak}`, 'success');
                    playSound(880, 0.3);
                } else {
                    stats.quizStreak = 0;
                    showStatus('Incorrect. Try again or start a new challenge.', 'error');
                    playSound(220, 0.3);
                }
                
                document.getElementById('quizScore').textContent = stats.quizScore;
                document.getElementById('quizStreak').textContent = stats.quizStreak;
            };

            // UI Functions
            const resetAllSwitches = () => {
                switches.forEach(sw => setSwitchState(sw, 'open', false));
                statusDiv.innerHTML = '';
                statusDiv.className = 'mt-6 p-4 rounded-lg transition-all duration-300';
                operationSelect.value = 'none';
                history = [];
                historyIndex = -1;
                updateHistoryButtons();
                clearTutorialHighlights();
            };

            const showStatus = (message, type) => {
                statusDiv.innerHTML = message;
                let baseClasses = 'mt-6 p-4 rounded-lg transition-all duration-300';
                if (type === 'success') {
                    statusDiv.className = `${baseClasses} bg-green-100 text-green-800`;
                } else if (type === 'error') {
                    statusDiv.className = `${baseClasses} bg-red-100 text-red-800`;
                } else if (type === 'warning') {
                    statusDiv.className = `${baseClasses} bg-amber-100 text-amber-800`;
                } else {
                    statusDiv.className = `${baseClasses} bg-blue-100 text-blue-800`;
                }
            };

            const updateStats = () => {
                const elapsed = Math.floor((Date.now() - stats.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('clickCount').textContent = stats.clicks;
                document.getElementById('operationCount').textContent = stats.operations;
                const successRate = stats.operations > 0 ? Math.round((stats.successful / stats.operations) * 100) : 0;
                document.getElementById('successRate').textContent = `${successRate}%`;
            };

            // Mode switching
            const switchMode = (mode) => {
                currentMode = mode;
                document.getElementById('practiceControls').classList.toggle('hidden', mode !== 'practice');
                document.getElementById('tutorialControls').classList.toggle('hidden', mode !== 'tutorial');
                document.getElementById('quizControls').classList.toggle('hidden', mode !== 'quiz');
                
                // Update tab styles
                const tabs = ['practice', 'tutorial', 'quiz'];
                tabs.forEach(tab => {
                    const tabBtn = document.getElementById(`${tab}Tab`);
                    if (tab === mode) {
                        tabBtn.classList.add('bg-indigo-600', 'text-white');
                        tabBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    } else {
                        tabBtn.classList.remove('bg-indigo-600', 'text-white');
                        tabBtn.classList.add('bg-gray-200', 'text-gray-700');
                    }
                });
                
                resetAllSwitches();
            };

            // Event Listeners
            switches.forEach(sw => {
                sw.addEventListener('click', () => {
                    if (currentMode === 'tutorial' && sw.classList.contains('tutorial-highlight')) {
                        nextTutorialStep();
                    } else if (currentMode !== 'tutorial') {
                        toggleSwitchState(sw);
                    }
                });
                
                // Tooltips
                sw.addEventListener('mouseenter', (e) => {
                    const tooltipText = sw.dataset.tooltip;
                    if (tooltipText) {
                        tooltip.textContent = tooltipText;
                        tooltip.classList.add('show');
                        const rect = sw.getBoundingClientRect();
                        tooltip.style.left = `${rect.left + rect.width / 2}px`;
                        tooltip.style.top = `${rect.top - 40}px`;
                    }
                });
                
                sw.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });

            // Control buttons
            document.getElementById('applyScenario').addEventListener('click', () => {
                const selectedOp = operationSelect.value;
                if (selectedOp === 'none') {
                    showStatus('Please select an operation scenario first.', 'warning');
                    return;
                }
                const requiredStates = interlockData[selectedOp];
                switches.forEach(sw => {
                    const switchId = sw.id;
                    if (requiredStates[switchId]) {
                        setSwitchState(sw, requiredStates[switchId]);
                    }
                });
                showStatus(`Showing correct configuration: ${requiredStates.description}`, 'info');
                stats.operations++;
                updateStats();
            });

            document.getElementById('checkConfig').addEventListener('click', () => {
                const selectedOp = operationSelect.value;
                if (selectedOp === 'none') {
                    showStatus('Please select an operation scenario first.', 'warning');
                    return;
                }

                const requiredStates = interlockData[selectedOp];
                let errors = [];

                switches.forEach(sw => {
                    const switchId = sw.id;
                    const currentState = sw.dataset.state;
                    const requiredState = requiredStates[switchId];
                    if (requiredState && currentState !== requiredState) {
                        errors.push(`<b>${switchId}</b> is <b>${currentState}</b> but should be <b>${requiredState}</b>`);
                    }
                });

                stats.operations++;
                if (errors.length === 0) {
                    stats.successful++;
                    showStatus('<strong>âœ“ Perfect!</strong> Configuration is correct and safe.', 'success');
                    playSound(660, 0.2);
                } else {
                    const errorList = errors.map(e => `<li>${e}</li>`).join('');
                    showStatus(`<strong>âš  Unsafe Configuration!</strong><ul class="list-disc list-inside mt-2">${errorList}</ul>`, 'error');
                }
                updateStats();
            });

            document.getElementById('reset').addEventListener('click', resetAllSwitches);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);

            // Mode tabs
            document.getElementById('practiceTab').addEventListener('click', () => switchMode('practice'));
            document.getElementById('tutorialTab').addEventListener('click', () => switchMode('tutorial'));
            document.getElementById('quizTab').addEventListener('click', () => switchMode('quiz'));

            // Tutorial controls
            document.getElementById('startTutorial').addEventListener('click', () => startTutorial('basic_switching'));
            document.getElementById('nextStep').addEventListener('click', nextTutorialStep);

            // Quiz controls
            document.getElementById('startQuiz').addEventListener('click', startQuiz);
            document.getElementById('submitQuiz').addEventListener('click', checkQuizAnswer);

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                darkMode = !darkMode;
                body.classList.toggle('dark', darkMode);
                document.getElementById('darkModeText').textContent = darkMode ? 'Light Mode' : 'Dark Mode';
                document.getElementById('darkModeIcon').textContent = darkMode ? 'â˜€ï¸' : 'ðŸŒ™';
            });

            // Sound toggle
            document.getElementById('soundToggle').addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                document.getElementById('soundStatus').textContent = soundEnabled ? 'ON' : 'OFF';
                document.getElementById('soundIcon').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            });

            // Power flow toggle
            document.getElementById('togglePowerFlow').addEventListener('click', () => {
                powerFlowVisible = !powerFlowVisible;
                document.getElementById('togglePowerFlow').textContent = powerFlowVisible ? 'Hide Power Flow' : 'Show Power Flow';
                updatePowerFlow();
            });

            // Labels toggle
            document.getElementById('toggleLabels').addEventListener('click', () => {
                const labels = document.querySelectorAll('.label');
                labels.forEach(label => {
                    label.style.display = label.style.display === 'none' ? 'block' : 'none';
                });
            });

            // Initialize
            resetAllSwitches();
            updateHistoryButtons();
            setInterval(updateStats, 1000);
        });
    </script>
</body>
</html>
